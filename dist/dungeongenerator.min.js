/*! Dungeon Generator - v1.5.0 - 2014-02-21
* https://github.com/stefanweck/dungeongeneration
* Copyright (c) 2014 Stefan Weck */
function initializeCanvas(){canvas=document.getElementById("canvas"),canvas.width=900,canvas.height=600;var a={canvas:canvas,tilesX:60,tilesY:40,tileSize:15,maxRooms:10,minRoomWidth:6,maxRoomWidth:12,minRoomHeight:6,maxRoomHeight:12,debug:!1};game=new Roguelike.Game(a)}var Roguelike=Roguelike||{VERSION:"1.5"};Roguelike.Game=function(a){this.isInitialized=!1,this.controls=null,this.map=null,this.camera=null,this.player=null,this.renderer=null,this.settings={canvas:null,tilesX:60,tilesY:40,tileSize:20,maxRooms:10,minRoomWidth:6,maxRoomWidth:12,minRoomHeight:6,maxRoomHeight:12,debug:!1},this.settings=Roguelike.Utils.extend(this.settings,a),this.initialize()},Roguelike.Game.prototype={initialize:function(){function a(a){c.controls.keyDown(a)}function b(a){c.controls.keyUp(a)}if(!this.isInitialized){this.settings.debug===!0&&canvas.addEventListener("mousemove",Roguelike.Utils.debugTiles,!1);var c=this;this.controls=new Roguelike.Controls,window.addEventListener("keydown",a,!1),window.addEventListener("keyup",b,!1),this.map=new Roguelike.Map(this),this.map.initialize(),this.map.mapFactory.generateRooms(),this.map.addRooms(),this.map.mapFactory.placeEntranceExitObjects(),this.camera=new Roguelike.Camera(this,{x:0,y:0}),this.player=new Roguelike.Player(this,this.map.entrance),this.camera.follow(this.player,this.settings.canvas.width/2,this.settings.canvas.height/2),this.renderer=new Roguelike.Renderer(this),this.renderer.drawMap(),this.renderer.drawPlayer(),updateInterval=setInterval(function(){c.update()},1e3/(1e3/30)),this.isInitialized=!0}},update:function(){this.player.update(),this.camera.update(),this.renderer.update()}},Roguelike.Renderer=function(a){this.game=a,this.canvas=a.settings.canvas,this.context=a.settings.canvas.getContext("2d"),this.tileColors=["#302222","#443939","#6B5B45"],this.objectColors=["#963535","#CCC"]},Roguelike.Renderer.prototype={drawMap:function(){for(this.context.save(),y=0;y<this.game.map.tilesY;y++)for(x=0;x<this.game.map.tilesX;x++){var a=this.game.map.tiles[y][x].type;this.context.fillStyle=this.tileColors[a],this.context.fillRect(x*this.game.map.tileSize-this.game.camera.position.x,y*this.game.map.tileSize-this.game.camera.position.y,this.game.map.tileSize,this.game.map.tileSize)}this.context.restore()},drawPlayer:function(){this.context.save(),this.context.fillStyle="#F5F522",this.context.fillRect(this.game.player.position.x*this.game.map.tileSize-this.game.camera.position.x,this.game.player.position.y*this.game.map.tileSize-this.game.camera.position.y,this.game.map.tileSize,this.game.map.tileSize),this.context.restore()},drawObjects:function(){for(this.context.save(),i=0;i<this.game.map.objects.length;i++){var a=this.game.map.objects[i];this.context.fillStyle=this.objectColors[a.type],this.context.fillRect(a.position.x*this.game.map.tileSize-this.game.camera.position.x,a.position.y*this.game.map.tileSize-this.game.camera.position.y,this.game.map.tileSize,this.game.map.tileSize)}this.context.restore()},update:function(){this.context.clearRect(0,0,this.game.settings.canvas.width,this.game.settings.canvas.height),this.drawMap(),this.drawObjects(),this.drawPlayer()}},Roguelike.MapFactory=function(a){this.game=a},Roguelike.MapFactory.prototype={generateRooms:function(){for(var a=this.game.map.maxRooms+10,b=0;this.game.map.rooms.length<this.game.map.maxRooms&&!(b>=a);){var c=Roguelike.Utils.randomNumber(this.game.map.minRoomWidth,this.game.map.maxRoomWidth),d=Roguelike.Utils.randomNumber(this.game.map.minRoomHeight,this.game.map.maxRoomHeight),e=Roguelike.Utils.randomNumber(1,this.game.map.tilesX-c-1),f=Roguelike.Utils.randomNumber(1,this.game.map.tilesY-d-1),g=new Roguelike.Room(e,f,c,d);b++,this.game.map.roomIntersectsWith(g)||(g.initialize(),g.generateExit(),0===this.game.map.rooms.length&&g.generateDungeonEntrance(this.game.map),this.game.map.rooms.push(g),b=0)}},generateCorridors:function(){for(var a=this.game.map,b=1;b<a.rooms.length;b++)this.generateCorridor(a.rooms[b],a.rooms[b-1])},generateCorridor:function(a,b){var c={x:a.x1+a.exit.x,y:a.y1+a.exit.y},d={x:b.x1+b.exit.x,y:b.y1+b.exit.y};if(d.x-c.x>0)for(i=d.x;i>=c.x;i--)this.generateHorizontalCorridor(i,d.y);else for(i=d.x;i<=c.x;i++)this.generateHorizontalCorridor(i,d.y);if(d.y-c.y>0)for(i=d.y;i>=c.y;i--)this.generateVerticalCorridor(c.x,i);else for(i=d.y;i<=c.y;i++)this.generateVerticalCorridor(c.x,i)},generateHorizontalCorridor:function(a,b){if(1===this.game.map.tiles[b][a].type&&2!==this.game.map.tiles[b+1][a].type&&2!==this.game.map.tiles[b-1][a].type&&Roguelike.Utils.randomNumber(1,100)>70){var c=new Roguelike.Object({x:a,y:b},1);this.game.map.objects.push(c),console.log(this.game.map.objects)}this.game.map.tiles[b][a].type=2,(0===this.game.map.tiles[b+1][a].type||3===this.game.map.tiles[b+1][a].type)&&(this.game.map.tiles[b+1][a].type=1),(0===this.game.map.tiles[b-1][a].type||3===this.game.map.tiles[b-1][a].type)&&(this.game.map.tiles[b-1][a].type=1)},generateVerticalCorridor:function(a,b){this.game.map.tiles[b][a].type=2,0===this.game.map.tiles[b][a+1].type&&(this.game.map.tiles[b][a+1].type=1),0===this.game.map.tiles[b][a-1].type&&(this.game.map.tiles[b][a-1].type=1)},placeEntranceExitObjects:function(){var a=new Roguelike.Object(this.game.map.entrance,0);this.game.map.objects.push(a)}},Roguelike.Tile=function(a,b){this.type=a,this.belongsTo=b},Roguelike.Object=function(a,b){this.position=a,this.type=b},Roguelike.Object.prototype={},Roguelike.Player=function(a,b){this.game=a,this.position=Object.create(b),this.speed=1,this.lastKey=0},Roguelike.Player.prototype={update:function(){this.lastKey!==this.game.controls.current&&(this.lastKey=this.game.controls.current,this.game.controls.left&&2===this.game.map.tiles[this.position.y][this.position.x-this.speed].type?this.position.x-=this.speed:this.game.controls.up&&2===this.game.map.tiles[this.position.y-this.speed][this.position.x].type?this.position.y-=this.speed:this.game.controls.right&&2===this.game.map.tiles[this.position.y][this.position.x+this.speed].type?this.position.x+=this.speed:this.game.controls.down&&2===this.game.map.tiles[this.position.y+this.speed][this.position.x].type&&(this.position.y+=this.speed))}},Roguelike.Controls=function(){this.left=!1,this.right=!1,this.up=!1,this.down=!1,this.current=0},Roguelike.Controls.prototype={keyDown:function(a){switch(a.keyCode){case 37:case 65:this.left=!0;break;case 38:case 87:this.up=!0;break;case 39:case 68:this.right=!0;break;case 40:case 83:this.down=!0}this.current=a.keyCode},keyUp:function(a){switch(a.keyCode){case 37:case 65:this.left=!1;break;case 38:case 87:this.up=!1;break;case 39:case 68:this.right=!1;break;case 40:case 83:this.down=!1}this.current=0}},Roguelike.Boundary=function(a,b,c,d){this.left=a||0,this.top=b||0,this.width=c||0,this.height=d||0,this.right=this.left+this.width,this.bottom=this.top+this.height},Roguelike.Boundary.prototype={set:function(a,b,c,d){this.left=a,this.top=b,this.width=c||this.width,this.height=d||this.height,this.right=this.left+this.width,this.bottom=this.top+this.height},isWithin:function(a){return a.left<=this.left&&a.right>=this.right&&a.top<=this.top&&a.bottom>=this.bottom},isOverlapping:function(a){return this.left<a.right&&a.left<this.right&&this.top<a.bottom&&a.top<this.bottom}},Roguelike.Camera=function(a,b){this.game=a,this.position=b,this.viewportWidth=a.settings.canvas.width,this.viewportHeight=a.settings.canvas.height,this.minimumDistanceX=0,this.minimumDistanceY=0,this.followObject=null,this.viewportBoundary=new Roguelike.Boundary(this.position.x*a.settings.tileSize,this.position.y*a.settings.tileSize,this.viewportWidth,this.viewportHeight),this.mapBoundary=new Roguelike.Boundary(0,0,a.settings.tilesX*a.settings.tileSize,a.settings.tilesY*a.settings.tileSize)},Roguelike.Camera.prototype={follow:function(a,b,c){this.followObject=a,this.minimumDistanceX=b,this.minimumDistanceY=c},update:function(){null!==this.followObject&&(this.followObject.position.x*game.settings.tileSize-this.position.x+this.minimumDistanceX>this.viewportWidth?this.position.x=this.followObject.position.x*game.settings.tileSize-(this.viewportWidth-this.minimumDistanceX):this.followObject.position.x*game.settings.tileSize-this.minimumDistanceX<this.position.x&&(this.position.x=this.followObject.position.x*game.settings.tileSize-this.minimumDistanceX),this.followObject.position.y*game.settings.tileSize-this.position.y+this.minimumDistanceY>this.viewportHeight?this.position.y=this.followObject.position.y*game.settings.tileSize-(this.viewportHeight-this.minimumDistanceY):this.followObject.position.y*game.settings.tileSize-this.minimumDistanceY<this.position.y&&(this.position.y=this.followObject.position.y*game.settings.tileSize-this.minimumDistanceY)),this.viewportBoundary.set(this.position.x,this.position.y),this.viewportBoundary.isWithin(this.mapBoundary)||(this.viewportBoundary.left<this.mapBoundary.left&&(this.position.x=this.mapBoundary.left),this.viewportBoundary.top<this.mapBoundary.top&&(this.position.y=this.mapBoundary.top),this.viewportBoundary.right>this.mapBoundary.right&&(this.position.x=this.mapBoundary.right-this.viewportWidth),this.viewportBoundary.bottom>this.mapBoundary.bottom&&(this.position.y=this.mapBoundary.bottom-this.viewportHeight))}},Roguelike.Map=function(a){this.game=a,this.tilesX=a.settings.tilesX,this.tilesY=a.settings.tilesY,this.maxRooms=a.settings.maxRooms,this.rooms=[],this.corridors=[],this.tiles=[],this.objects=[],this.tileSize=a.settings.tileSize,this.minRoomWidth=a.settings.minRoomWidth,this.maxRoomWidth=a.settings.maxRoomWidth,this.minRoomHeight=a.settings.minRoomHeight,this.maxRoomHeight=a.settings.maxRoomHeight,this.mapFactory=null,this.entrance=null},Roguelike.Map.prototype={initialize:function(){for(this.mapFactory=new Roguelike.MapFactory(this.game),y=0;y<this.tilesY;y++)for(this.tiles[y]=[],x=0;x<this.tilesX;x++)this.tiles[y][x]=new Roguelike.Tile(0)},roomIntersectsWith:function(a){for(var b=0;b<this.rooms.length;b++)if(a.x1<=this.rooms[b].x2&&a.x2>=this.rooms[b].x1&&a.y1<=this.rooms[b].y2&&a.y2>=this.rooms[b].y1)return!0;return!1},addRooms:function(){for(var a=0;a<this.rooms.length;a++)for(y=this.rooms[a].y1;y<this.rooms[a].y2;y++){var b=this.rooms[a].y2-y-1;for(x=this.rooms[a].x1;x<this.rooms[a].x2;x++){var c=this.rooms[a].x2-x-1,d=this.rooms[a].layout[b][c];this.tiles[y][x]=d}}this.mapFactory.generateCorridors(this)}},Roguelike.Room=function(a,b,c,d){this.x1=a,this.x2=c+a,this.y1=b,this.y2=b+d,this.w=c,this.h=d,this.layout=[],this.exit=null},Roguelike.Room.prototype={initialize:function(){for(y=0;y<this.h;y++)for(this.layout[y]=[],x=0;x<this.w;x++)this.layout[y][x]=0===y||y===this.h-1||0===x||x===this.w-1?new Roguelike.Tile(1,this):new Roguelike.Tile(2,this)},generateExit:function(){switch(Roguelike.Utils.randomNumber(1,4)){case 1:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:this.h-2};break;case 2:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:1};break;case 3:this.exit={x:this.w-2,y:Roguelike.Utils.randomNumber(1,this.h-2)};break;case 4:this.exit={x:1,y:Roguelike.Utils.randomNumber(1,this.h-2)}}},generateDungeonEntrance:function(a){var b=Roguelike.Utils.randomNumber(2,this.w-3),c=Roguelike.Utils.randomNumber(2,this.h-3);a.entrance={x:this.x1+b,y:this.y1+c}}},Roguelike.Utils={randomNumber:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},getMousePos:function(a){var b=canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}},debugTiles:function(a){var b=Roguelike.Utils.getMousePos(a),c=Math.floor(b.x/15),d=Math.floor(b.y/15);if(console.clear(),game.renderer.draw(game.map),tileType=game.map.tiles[d][c].type,console.log(game.map.tiles[d][c]),oContext.fillStyle="rgba(255, 0, 0, 0.2)",game.map.tiles[d][c].belongsTo){var e=game.map.tiles[d][c].belongsTo;oContext.fillRect(e.x1*game.map.tileSize,e.y1*game.map.tileSize,e.w*game.map.tileSize,e.h*game.map.tileSize)}else oContext.fillRect(c*game.map.tileSize,d*game.map.tileSize,game.map.tileSize,game.map.tileSize)}},window.onload=function(){initializeCanvas()};