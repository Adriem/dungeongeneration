/*! Dungeon Generator - v1.6.5 - 2014-03-15
* https://github.com/stefanweck/dungeongeneration
* Copyright (c) 2014 Stefan Weck */
function initializeCanvas(){var a=document.getElementById("canvas");a.width=900,a.height=600;{var b={canvas:a,tilesX:60,tilesY:40,tileSize:25,maxRooms:15,minRoomWidth:6,maxRoomWidth:10,minRoomHeight:6,maxRoomHeight:10,debug:!1};new Roguelike.Game(b)}}var Roguelike=Roguelike||{VERSION:"1.6.5",Components:{},Systems:{}};Roguelike.Game=function(a){this.isInitialized=!1,this.map=null,this.systems=[],this.controlSystem=null,this.collisionSystem=null,this.camera=null,this.player=null,this.lightSource=null,this.renderer=null,this.settings={canvas:null,tilesX:60,tilesY:40,tileSize:20,maxRooms:10,minRoomWidth:6,maxRoomWidth:12,minRoomHeight:6,maxRoomHeight:12,debug:!1},this.settings=Roguelike.Utils.extend(this.settings,a),this.initialize()},Roguelike.Game.prototype={initialize:function(){this.isInitialized||(this.map=new Roguelike.Map(this),this.map.initialize(),this.map.entities=new Roguelike.Group(this),this.map.mapFactory.generateRooms(),this.map.addRooms(),this.map.mapFactory.generateCorridors(),this.map.mapFactory.generateDoors(),this.map.mapFactory.placeEntranceExitObjects(),this.camera=new Roguelike.Camera(this,{x:0,y:0}),this.lightSource=new Roguelike.LightSource(this,{radius:8,gradient:!0}),this.controlSystem=new Roguelike.Systems.Control(this),this.collisionSystem=new Roguelike.Systems.Collision(this),this.systems.push(new Roguelike.Systems.Render(this)),this.player=new Roguelike.Entity,this.player.addComponent(new Roguelike.Components.Health(100)),this.player.addComponent(new Roguelike.Components.Position(this.map.entrance.x,this.map.entrance.y)),this.player.addComponent(new Roguelike.Components.Sprite("#FF7300")),this.player.addComponent(new Roguelike.Components.KeyboardControl),this.map.entities.addEntity(this.player),this.camera.follow(this.player,this.settings.canvas.width/2,this.settings.canvas.height/2),this.renderer=new Roguelike.Renderer(this),this.update(),this.isInitialized=!0)},update:function(){for(var a=this.player.getComponent("position"),b=this.lightSource.update(a.x,a.y),c=0;c<b.length;c++)this.map.tiles[b[c].y][b[c].x].lightLevel=b[c].lightLevel,this.map.tiles[b[c].y][b[c].x].explored=!0;this.camera.update(),this.renderer.clear(),this.renderer.drawMap();for(var d=0;d<this.systems.length;d++)this.systems[d].update();this.renderer.drawLightMap()}},Roguelike.Renderer=function(a){this.game=a,this.canvas=a.settings.canvas,this.context=a.settings.canvas.getContext("2d"),this.tileColors=["#302222","#443939","#6B5B45"]},Roguelike.Renderer.prototype={drawMap:function(){this.context.save();for(var a=0;a<this.game.map.tilesY;a++)for(var b=0;b<this.game.map.tilesX;b++){var c=this.game.map.tiles[a][b].type;this.context.fillStyle=this.tileColors[c];var d=this.game.map.tileSize;this.context.fillRect(b*d-this.game.camera.position.x,a*d-this.game.camera.position.y,d,d)}this.context.restore()},drawLightMap:function(){this.context.save();for(var a=0;a<this.game.map.tilesY;a++)for(var b=0;b<this.game.map.tilesX;b++){this.context.fillStyle=this.game.map.tiles[a][b].explored===!0&&1-this.game.map.tiles[a][b].lightLevel>.7?"rgba(0, 0, 0, 0.7)":"rgba(0, 0, 0, "+(1-this.game.map.tiles[a][b].lightLevel)+")";var c=this.game.map.tileSize;this.context.fillRect(b*c-this.game.camera.position.x,a*c-this.game.camera.position.y,c,c)}this.context.restore()},clear:function(){this.context.clearRect(0,0,this.game.settings.canvas.width,this.game.settings.canvas.height)}},Roguelike.Utils={randomNumber:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},contains:function(a,b){for(var c=0;c<b.length;c++)if(b[c]===a)return c;return!1}},Roguelike.Camera=function(a,b){this.game=a,this.position=b,this.viewportWidth=a.settings.canvas.width,this.viewportHeight=a.settings.canvas.height,this.minimumDistanceX=0,this.minimumDistanceY=0,this.followObject=null,this.viewportBoundary=new Roguelike.Boundary(this.position.x*a.settings.tileSize,this.position.y*a.settings.tileSize,this.viewportWidth,this.viewportHeight),this.mapBoundary=new Roguelike.Boundary(0,0,a.settings.tilesX*a.settings.tileSize,a.settings.tilesY*a.settings.tileSize)},Roguelike.Camera.prototype={follow:function(a,b,c){this.followObject=a.components.position,this.minimumDistanceX=b,this.minimumDistanceY=c},update:function(){if(null!==this.followObject){var a=this.game.settings.tileSize;this.followObject.x*a-this.position.x+this.minimumDistanceX>this.viewportWidth?this.position.x=this.followObject.x*a-(this.viewportWidth-this.minimumDistanceX):this.followObject.x*a-this.minimumDistanceX<this.position.x&&(this.position.x=this.followObject.x*a-this.minimumDistanceX),this.followObject.y*a-this.position.y+this.minimumDistanceY>this.viewportHeight?this.position.y=this.followObject.y*a-(this.viewportHeight-this.minimumDistanceY):this.followObject.y*a-this.minimumDistanceY<this.position.y&&(this.position.y=this.followObject.y*a-this.minimumDistanceY)}this.viewportBoundary.set(this.position.x,this.position.y),this.viewportBoundary.isWithin(this.mapBoundary)||(this.viewportBoundary.left<this.mapBoundary.left&&(this.position.x=this.mapBoundary.left),this.viewportBoundary.top<this.mapBoundary.top&&(this.position.y=this.mapBoundary.top),this.viewportBoundary.right>this.mapBoundary.right&&(this.position.x=this.mapBoundary.right-this.viewportWidth),this.viewportBoundary.bottom>this.mapBoundary.bottom&&(this.position.y=this.mapBoundary.bottom-this.viewportHeight))}},Roguelike.Vector2=function(a,b){this.x=a,this.y=b},Roguelike.Vector2.prototype={add:function(){var a=pos.x-this.x,b=pos.y-this.y;return Math.abs(Math.sqrt(a*a+b*b))},distance:function(a){var b=a.x-this.x,c=a.y-this.y;return Math.abs(Math.sqrt(b*b+c*c))},manhattan:function(a){return Math.abs(this.x-a.x)+Math.abs(this.y-a.y)},clone:function(){return new Vector2(this.x,this.y)},toString:function(){return"("+this.x+", "+this.y+")"}},Roguelike.Boundary=function(a,b,c,d){this.left=a||0,this.top=b||0,this.width=c||0,this.height=d||0,this.right=this.left+this.width,this.bottom=this.top+this.height},Roguelike.Boundary.prototype={set:function(a,b,c,d){this.left=a,this.top=b,this.width=c||this.width,this.height=d||this.height,this.right=this.left+this.width,this.bottom=this.top+this.height},isWithin:function(a){return a.left<=this.left&&a.right>=this.right&&a.top<=this.top&&a.bottom>=this.bottom},isOverlapping:function(a){return this.left<a.right&&a.left<this.right&&this.top<a.bottom&&a.top<this.bottom}},Roguelike.Entity=function(){this.components={},this.onAddComponent=new Roguelike.Event,this.onRemoveComponent=new Roguelike.Event},Roguelike.Entity.prototype={hasComponent:function(a){return void 0!==this.components[a]},getComponent:function(a){return this.components[a]},addComponent:function(a){this.components[a.name]=a,this.onAddComponent.trigger(a)},removeComponent:function(a){this.components[a.name]=void 0,this.onRemoveComponent.trigger(a)}},Roguelike.Group=function(a){this.game=a,this.entities=[]},Roguelike.Group.prototype={addEntity:function(a){!a instanceof Roguelike.Entity||this.entities.push(a)},removeEntity:function(a){var b=Roguelike.Utils.contains(a,this.entities);b!==!1&&this.entities.splice(b,1)},getEntities:function(){for(var a=[],b=0;b<this.entities.length;b++){for(var c=[],d=0;d<arguments.length;d++)this.entities[b].components[arguments[d]]&&c.push(1);c.length===arguments.length&&a.push(this.entities[b])}return a}},Roguelike.Components.Sprite=function(a){this.name="sprite",this.color=a},Roguelike.Components.Health=function(a){this.name="health",this.health=this.maxHealth=a},Roguelike.Components.Health.prototype={isDead:function(){return this.health<=0}},Roguelike.Components.Door=function(){this.name="door"},Roguelike.Components.KeyboardControl=function(){this.name="keyboardControl"},Roguelike.Components.Position=function(a,b){this.name="position",this.x=a,this.y=b},Roguelike.Systems.Render=function(a){this.name="renderer",this.game=a,this.canvas=null,this.context=null,this.initialize()},Roguelike.Systems.Render.prototype={initialize:function(){this.canvas=this.game.settings.canvas,this.context=this.game.settings.canvas.getContext("2d")},update:function(){var a=this.game.map.entities.getEntities("position","sprite");this.context.save();for(var b=0;b<a.length;b++){var c=a[b].getComponent("sprite"),d=a[b].getComponent("position");this.context.fillStyle=c.color,this.context.fillRect(d.x*this.game.map.tileSize-this.game.camera.position.x,d.y*this.game.map.tileSize-this.game.camera.position.y,this.game.map.tileSize,this.game.map.tileSize)}this.context.restore()}},Roguelike.Systems.Control=function(a){this.name="control",this.game=a,this.keyboard=null,this.upKey=null,this.downKey=null,this.leftKey=null,this.rightKey=null,this.initialize()},Roguelike.Systems.Control.prototype={initialize:function(){this.keyboard=new Roguelike.Keyboard(this),this.keyboard.initialize();var a=this;this.upKey=this.keyboard.getKey(38);var b=function(){a.moveEntities("up")};this.upKey.onDown.on(38,b,a),this.downKey=this.keyboard.getKey(40);var c=function(){a.moveEntities("down")};this.downKey.onDown.on(40,c,a),this.leftKey=this.keyboard.getKey(37);var d=function(){a.moveEntities("left")};this.leftKey.onDown.on(37,d,a),this.rightKey=this.keyboard.getKey(39);var e=function(){a.moveEntities("right")};this.rightKey.onDown.on(39,e,a)},moveEntities:function(a){for(var b=this.game.map.entities.getEntities("keyboardControl","position"),c=0;c<b.length;c++)this.moveEntity(a,b[c]);this.game.update()},moveEntity:function(a,b){var c=b.getComponent("position"),d={};switch(a){case"left":d={x:c.x-1,y:c.y},this.game.collisionSystem.canMove(b,d)&&(c.x-=1);break;case"up":d={x:c.x,y:c.y-1},this.game.collisionSystem.canMove(b,d)&&(c.y-=1);break;case"right":d={x:c.x+1,y:c.y},this.game.collisionSystem.canMove(b,d)&&(c.x+=1);break;case"down":d={x:c.x,y:c.y+1},this.game.collisionSystem.canMove(b,d)&&(c.y+=1)}}},Roguelike.Systems.Collision=function(a){this.name="collision",this.game=a},Roguelike.Systems.Collision.prototype={canMove:function(a,b){var c=this.game.map.tiles[b.y][b.x];return 2!==c.type?!1:(0!==c.entities.length&&console.log(c.entities),!0)}},Roguelike.Event=function(){this.events={}},Roguelike.Event.prototype={on:function(a,b,c){this.events.hasOwnProperty(a)||(this.events[a]=[]),this.events[a].push([b,c])},trigger:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.events[a];if(void 0!==c)for(var d=0;d<c.length;d++){var e,f=c[d][0];e=void 0===c[d][1]?this:c[d][1],f.apply(e,b)}}},Roguelike.Key=function(a){this.keyCode=a,this.isDown=!1,this.isUp=!1,this.lastDown=0,this.lastUp=0,this.delay=50,this.onDown=new Roguelike.Event,this.onUp=new Roguelike.Event},Roguelike.Key.prototype={processKeyDown:function(a){this.isDown?a.timeStamp>this.lastDown+this.delay&&(this.onDown.trigger(this.keyCode),this.lastDown=a.timeStamp):(this.isDown=!0,this.isUp=!1,this.lastDown=a.timeStamp,this.onDown.trigger(this.keyCode))},processKeyUp:function(a){this.isDown=!1,this.isUp=!0,this.lastUp=a.timeStamp,this.onUp.trigger(this.keyCode)}},Roguelike.Keyboard=function(a){this.game=a,this.keys={}},Roguelike.Keyboard.prototype={initialize:function(){var a=this;this._onKeyDown=function(b){return a.processKeyDown(b)},this._onKeyUp=function(b){return a.processKeyUp(b)},window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)},getKey:function(a){return void 0===this.keys[a]&&(this.keys[a]=new Roguelike.Key(a)),this.keys[a]},processKeyDown:function(a){void 0!==this.keys[a.keyCode]&&(a.preventDefault(),this.keys[a.keyCode].processKeyDown(a))},processKeyUp:function(a){void 0!==this.keys[a.keyCode]&&this.keys[a.keyCode].processKeyUp(a)}},Roguelike.Tile=function(a,b,c){this.type=a,this.belongsTo=c||null,this.entities=[],this.blockLight=b,this.lightLevel=0,this.explored=!1},Roguelike.Tile.prototype={},Roguelike.Map=function(a){this.game=a,this.entities=null,this.tilesX=a.settings.tilesX,this.tilesY=a.settings.tilesY,this.maxRooms=a.settings.maxRooms,this.rooms=[],this.corridors=[],this.tiles=[],this.objects=[],this.tileSize=a.settings.tileSize,this.minRoomWidth=a.settings.minRoomWidth,this.maxRoomWidth=a.settings.maxRoomWidth,this.minRoomHeight=a.settings.minRoomHeight,this.maxRoomHeight=a.settings.maxRoomHeight,this.mapFactory=null,this.entrance=null,this.exit=null},Roguelike.Map.prototype={initialize:function(){for(this.mapFactory=new Roguelike.MapFactory(this.game),y=0;y<this.tilesY;y++)for(this.tiles[y]=[],x=0;x<this.tilesX;x++)this.tiles[y][x]=new Roguelike.Tile(0,!0)},roomIntersectsWith:function(a){for(var b=0;b<this.rooms.length;b++)if(a.x1<=this.rooms[b].x2&&a.x2>=this.rooms[b].x1&&a.y1<=this.rooms[b].y2&&a.y2>=this.rooms[b].y1)return!0;return!1},addRooms:function(){for(var a=0;a<this.rooms.length;a++)for(y=this.rooms[a].y1;y<this.rooms[a].y2;y++){var b=this.rooms[a].y2-y-1;for(x=this.rooms[a].x1;x<this.rooms[a].x2;x++){var c=this.rooms[a].x2-x-1,d=this.rooms[a].layout[b][c];this.tiles[y][x]=d}}}},Roguelike.MapFactory=function(a){this.game=a,this.possibleDoorLocations=[]},Roguelike.MapFactory.prototype={generateRooms:function(){for(var a=this.game.map,b=this.game.map.maxRooms+10,c=0;a.rooms.length<a.maxRooms&&!(c>=b);){var d=Roguelike.Utils.randomNumber(a.minRoomWidth,a.maxRoomWidth),e=Roguelike.Utils.randomNumber(a.minRoomHeight,a.maxRoomHeight),f=Roguelike.Utils.randomNumber(1,a.tilesX-d-1),g=Roguelike.Utils.randomNumber(1,a.tilesY-e-1),h=new Roguelike.Room(f,g,d,e);c++,a.roomIntersectsWith(h)||(h.initialize(),h.generateExit(),a.rooms.push(h),c=0)}},generateCorridors:function(){for(var a=this.game.map,b=1;b<a.rooms.length;b++)this.generateCorridor(a.rooms[b],a.rooms[b-1])},generateCorridor:function(a,b){var c={x:a.x1+a.exit.x,y:a.y1+a.exit.y},d={x:b.x1+b.exit.x,y:b.y1+b.exit.y};if(d.x-c.x>0)for(var e=d.x;e>=c.x;e--)this.generateHorizontalCorridor(e,d.y);else for(var e=d.x;e<=c.x;e++)this.generateHorizontalCorridor(e,d.y);if(d.y-c.y>0)for(var e=d.y;e>=c.y;e--)this.generateVerticalCorridor(c.x,e);else for(var e=d.y;e<=c.y;e++)this.generateVerticalCorridor(c.x,e)},generateHorizontalCorridor:function(a,b){var c=this.game.map,d=c.tiles[b][a],e=c.tiles[b+1][a],f=c.tiles[b-1][a];1===d.type&&1===e.type&&1===f.type&&this.possibleDoorLocations.push({x:a,y:b}),d.type=2,d.blockLight=!1,0===e.type&&(e.type=1),0===f.type&&(f.type=1)},generateVerticalCorridor:function(a,b){var c=this.game.map,d=c.tiles[b][a],e=c.tiles[b][a+1],f=c.tiles[b][a-1];1===d.type&&1===e.type&&1===f.type&&this.possibleDoorLocations.push({x:a,y:b}),d.type=2,d.blockLight=!1,0===e.type&&(e.type=1),0===f.type&&(f.type=1),0===c.tiles[b+1][a+1].type&&(c.tiles[b+1][a+1].type=1),0===c.tiles[b-1][a-1].type&&(c.tiles[b-1][a-1].type=1),0===c.tiles[b-1][a+1].type&&(c.tiles[b-1][a+1].type=1),0===c.tiles[b+1][a-1].type&&(c.tiles[b+1][a-1].type=1)},generateDoors:function(){for(var a=0;a<this.possibleDoorLocations.length;a++){var b=this.possibleDoorLocations[a],c=this.game.map.tiles[b.y][b.x-1],d=this.game.map.tiles[b.y][b.x+1],e=this.game.map.tiles[b.y+1][b.x],f=this.game.map.tiles[b.y-1][b.x],g=Roguelike.Utils.randomNumber(0,100);1===c.type&&1===d.type&&0===e.entities.length&&0===f.entities.length&&2===e.type&&2===f.type&&g>60?this.placeDoor(b):2===c.type&&2===d.type&&0===c.entities.length&&0===d.entities.length&&1===e.type&&1===f.type&&g>60&&this.placeDoor(b)}},placeDoor:function(a){var b=this.game.map.tiles[a.y][a.x],c=new Roguelike.Entity;c.addComponent(new Roguelike.Components.Position(a.x,a.y)),c.addComponent(new Roguelike.Components.Sprite("#FFD900")),this.game.map.entities.addEntity(c),b.entities.push(c),b.blockLight=!0},placeEntranceExitObjects:function(){var a=Roguelike.Utils.randomNumber(0,this.game.map.rooms.length-1),b=this.game.map.rooms[a],c=this.game.map.rooms[a+1],d=b.getRandomPosition(),e=c.getRandomPosition();this.game.map.entrance=d,this.game.map.exit=e;var f=new Roguelike.Entity;f.addComponent(new Roguelike.Components.Position(d.x,d.y)),f.addComponent(new Roguelike.Components.Sprite("#BD2D2D"));var g=new Roguelike.Entity;g.addComponent(new Roguelike.Components.Position(e.x,e.y)),g.addComponent(new Roguelike.Components.Sprite("#BD2D2D")),this.game.map.entities.addEntity(f),this.game.map.entities.addEntity(g)}},Roguelike.Room=function(a,b,c,d){this.x1=a,this.x2=c+a,this.y1=b,this.y2=b+d,this.w=c,this.h=d,this.layout=[],this.exit=null},Roguelike.Room.prototype={initialize:function(){for(var a=0;a<this.h;a++){this.layout[a]=[];for(var b=0;b<this.w;b++)this.layout[a][b]=0===a||a===this.h-1||0===b||b===this.w-1?new Roguelike.Tile(1,!0,this):new Roguelike.Tile(2,!1,this)}},generateExit:function(){switch(Roguelike.Utils.randomNumber(1,4)){case 1:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:this.h-2};break;case 2:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:1};break;case 3:this.exit={x:this.w-2,y:Roguelike.Utils.randomNumber(1,this.h-2)};break;case 4:this.exit={x:1,y:Roguelike.Utils.randomNumber(1,this.h-2)}}},getRandomPosition:function(){var a=Roguelike.Utils.randomNumber(2,this.w-3),b=Roguelike.Utils.randomNumber(2,this.h-3);return a+=this.x1,b+=this.y1,{x:a,y:b}}},Roguelike.LightSource=function(a,b){this.game=a,this.gradient=b.gradient,this.mapSize={x:a.map.tilesX,y:a.map.tilesY},this.tiles=[],this.position=new Roguelike.Vector2(-1,-1),this.radius=b.radius,this.oldRadius=b.radius,this.mult=[[1,0,0,-1,-1,0,0,1],[0,1,-1,0,0,-1,1,0],[0,1,1,0,0,-1,-1,0],[1,0,0,1,-1,0,0,-1]]},Roguelike.LightSource.prototype={doesTileBlock:function(a,b){return this.game.map.tiles[b][a].blockLight},calculateOctant:function(a,b,c,d,e,f,g,h,i,j,k){this.tiles.push({x:a,y:b,lightLevel:0});var l=0;if(!(e>d))for(var m=f*f,n=c;f+1>n;n++){for(var o=-n-1,p=-n,q=!1;0>=o;){o+=1;var r=a+o*g+p*h,s=b+o*i+p*j;if(r<this.mapSize.x&&r>=0&&s<this.mapSize.y&&s>=0){var t=(o-.5)/(p+.5),u=(o+.5)/(p-.5);if(u>d)continue;if(e>t)break;if(m>o*o+p*p){var v=new Roguelike.Vector2(r,s),w=this.position,x=(v.x-w.x)*(v.x-w.x)+(v.y-w.y)*(v.y-w.y);this.tiles.push({x:r,y:s,lightLevel:this.gradient===!1?1:1-x/(this.radius*this.radius)})}if(q){if(this.doesTileBlock(r,s)){l=u;continue}q=!1,d=l}else this.doesTileBlock(r,s)&&f>n&&(q=!0,this.calculateOctant(a,b,n+1,d,t,this.radius,g,h,i,j,k+1),l=u)}}if(q)break}},clear:function(){for(var a=this.tiles.length;a--;)this.tiles[a].lightLevel=0;var b=this.tiles;return this.tiles=[],b},calculate:function(){for(var a=0;8>a;a++)this.calculateOctant(this.position.x,this.position.y,1,1,0,this.radius,this.mult[0][a],this.mult[1][a],this.mult[2][a],this.mult[3][a],0);return this.tiles.push({x:this.position.x,y:this.position.y,lightLevel:1}),this.tiles},update:function(a,b){return this.position=new Roguelike.Vector2(a,b),this.clear().concat(this.calculate())}},window.onload=function(){initializeCanvas()};