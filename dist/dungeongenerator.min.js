/*! Dungeon Generator - v1.2 - 2014-02-15
* https://github.com/stefanweck/dungeongeneration
* Copyright (c) 2014 Stefan Weck */
function initializeCanvas(){canvas=document.getElementById("canvas"),canvas.width=900,canvas.height=600;var a={canvas:canvas,tilesX:60,tilesY:40,tileSize:15,maxRooms:10,minRoomWidth:6,maxRoomWidth:12,minRoomHeight:6,maxRoomHeight:12,debug:!1};canvas.addEventListener("click",function(){game=new Roguelike.Game(a)},!1),game=new Roguelike.Game(a)}var Roguelike=Roguelike||{VERSION:"1.2"};Roguelike.Game=function(a){this.isInitialized=!1,this.map=null,this.renderer=null,this.settings={canvas:null,tilesX:60,tilesY:40,tileSize:20,maxRooms:10,minRoomWidth:6,maxRoomWidth:12,minRoomHeight:6,maxRoomHeight:12,debug:!1},this.settings=Roguelike.Utils.extend(this.settings,a),this.initialize()},Roguelike.Game.prototype={initialize:function(){this.isInitialized||(this.settings.debug===!0&&canvas.addEventListener("mousemove",Roguelike.Utils.debugTiles,!1),this.map=new Roguelike.Map(this),this.map.initialize(),this.map.roomFactory.generateRooms(this),this.map.addRooms(),this.renderer=new Roguelike.Renderer,this.renderer.draw(this))}},Roguelike.Renderer=function(){this.colors=["#302222","#443939","#6B5B45","#CCC"]},Roguelike.Renderer.prototype={draw:function(a){var b=a.settings.canvas.getContext("2d");for(y=0;y<a.map.tilesY;y++)for(x=0;x<a.map.tilesX;x++){var c=a.map.tiles[y][x].type;b.fillStyle=this.colors[c],b.fillRect(x*a.map.tileSize,y*a.map.tileSize,a.map.tileSize,a.map.tileSize)}}},Roguelike.RoomFactory=function(){},Roguelike.RoomFactory.prototype={generateRooms:function(a){for(var b=a.map.maxRooms+10,c=0;a.map.rooms.length<a.map.maxRooms&&!(c>=b);){var d=Roguelike.Utils.randomNumber(a.map.minRoomWidth,a.map.maxRoomWidth),e=Roguelike.Utils.randomNumber(a.map.minRoomHeight,a.map.maxRoomHeight),f=Roguelike.Utils.randomNumber(1,a.map.tilesX-d-1),g=Roguelike.Utils.randomNumber(1,a.map.tilesY-e-1),h=new Roguelike.Room(f,g,d,e);c++,a.map.roomIntersectsWith(h)||(h.initialize(),h.generateExit(),a.map.rooms.push(h),c=0)}},generateCorridors:function(a){for(var b=0;b<a.corridors.length;b++)this.generateCorridor(a,a.corridors[b])},generateCorridor:function(a,b){if(b.x-b.prevx>0)for(i=b.x;i>=b.prevx;i--)this.generateHorizontalCorridor(a,i,b.y);else for(i=b.x;i<=b.prevx;i++)this.generateHorizontalCorridor(a,i,b.y);if(b.y-b.prevy>0)for(i=b.y;i>=b.prevy;i--)this.generateVerticalCorridor(a,b.prevx,i);else for(i=b.y;i<=b.prevy;i++)this.generateVerticalCorridor(a,b.prevx,i)},generateHorizontalCorridor:function(a,b,c){a.tiles[c][b].type=1===a.tiles[c][b].type&&2!==a.tiles[c+1][b].type&&2!==a.tiles[c-1][b].type&&Roguelike.Utils.randomNumber(1,100)>70?3:2,(0===a.tiles[c+1][b].type||3===a.tiles[c+1][b].type)&&(a.tiles[c+1][b].type=1),(0===a.tiles[c-1][b].type||3===a.tiles[c-1][b].type)&&(a.tiles[c-1][b].type=1)},generateVerticalCorridor:function(a,b,c){a.tiles[c][b].type=2,0===a.tiles[c][b+1].type&&(a.tiles[c][b+1].type=1),0===a.tiles[c][b-1].type&&(a.tiles[c][b-1].type=1)}},Roguelike.Tile=function(a,b){this.type=a,this.belongsTo=b},Roguelike.Map=function(a){this.tilesX=a.settings.tilesX,this.tilesY=a.settings.tilesY,this.maxRooms=a.settings.maxRooms,this.rooms=[],this.corridors=[],this.tiles=[],this.tileSize=a.settings.tileSize,this.minRoomWidth=a.settings.minRoomWidth,this.maxRoomWidth=a.settings.maxRoomWidth,this.minRoomHeight=a.settings.minRoomHeight,this.maxRoomHeight=a.settings.maxRoomHeight,this.roomFactory=null},Roguelike.Map.prototype={initialize:function(){for(this.roomFactory=new Roguelike.RoomFactory,y=0;y<this.tilesY;y++)for(this.tiles[y]=[],x=0;x<this.tilesX;x++)this.tiles[y][x]=new Roguelike.Tile(0)},roomIntersectsWith:function(a){for(var b=0;b<this.rooms.length;b++)if(a.x1<=this.rooms[b].x2&&a.x2>=this.rooms[b].x1&&a.y1<=this.rooms[b].y2&&a.y2>=this.rooms[b].y1)return!0;return!1},addRooms:function(){for(var a=[],b=[],c=0;c<this.rooms.length;c++){for(a.x=b.x,a.y=b.y,y=this.rooms[c].y1;y<this.rooms[c].y2;y++){var d=this.rooms[c].y2-y-1;for(x=this.rooms[c].x1;x<this.rooms[c].x2;x++){var e=this.rooms[c].x2-x-1,f=this.rooms[c].layout[d][e];this.tiles[y][x]=f,3===f.type&&(b.x=x,b.y=y)}}if(0!==c){var g={x:b.x,y:b.y,prevx:a.x,prevy:a.y};this.corridors.push(g)}}this.roomFactory.generateCorridors(this)}},Roguelike.Room=function(a,b,c,d){this.x1=a,this.x2=c+a,this.y1=b,this.y2=b+d,this.w=c,this.h=d,this.layout=[]},Roguelike.Room.prototype={initialize:function(){for(y=0;y<this.h;y++)for(this.layout[y]=[],x=0;x<this.w;x++)this.layout[y][x]=0===y||y===this.h-1||0===x||x===this.w-1?new Roguelike.Tile(1,this):new Roguelike.Tile(2,this)},generateExit:function(){switch(Roguelike.Utils.randomNumber(1,4)){case 1:this.layout[this.h-2][Roguelike.Utils.randomNumber(1,this.w-2)].type=3;break;case 2:this.layout[1][Roguelike.Utils.randomNumber(1,this.w-2)].type=3;break;case 3:this.layout[Roguelike.Utils.randomNumber(1,this.h-2)][this.w-2].type=3;break;case 4:this.layout[Roguelike.Utils.randomNumber(1,this.h-2)][1].type=3}}},Roguelike.Utils={randomNumber:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},getMousePos:function(a){var b=canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}},debugTiles:function(a){var b=Roguelike.Utils.getMousePos(a),c=Math.floor(b.x/15),d=Math.floor(b.y/15);if(console.clear(),game.renderer.draw(game.map),tileType=game.map.tiles[d][c].type,console.log(game.map.tiles[d][c]),oContext.fillStyle="rgba(255, 0, 0, 0.2)",game.map.tiles[d][c].belongsTo){var e=game.map.tiles[d][c].belongsTo;oContext.fillRect(e.x1*game.map.tileSize,e.y1*game.map.tileSize,e.w*game.map.tileSize,e.h*game.map.tileSize)}else oContext.fillRect(c*game.map.tileSize,d*game.map.tileSize,game.map.tileSize,game.map.tileSize)}},window.onload=function(){initializeCanvas()};